From 74eefdb1b0a4b02ddef9b8831757f03a41be29b3 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Tue, 16 Feb 2016 17:11:15 +0200
Subject: [PATCH 0103/2241] mv_xor_v2: add compatbile for zor-z1 to reduce
 rd/wr burst size

Change-Id: I6d4168d5ad0cc558327219022dc14e69b48877fa
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
---
 .../boot/dts/marvell/armada-ap806-z1-quad.dtsi     | 19 ++++++++++
 drivers/dma/mv_xor_v2.c                            | 43 ++++++++++++++++++++--
 2 files changed, 58 insertions(+), 4 deletions(-)

diff --git a/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi b/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi
index fce6c2a..14e5572 100644
--- a/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-ap806-z1-quad.dtsi
@@ -80,5 +80,24 @@
 		};
 	};
 
+	ap806 {
+		config-space {
+			xor0@400000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+
+			xor1@420000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+
+			xor2@440000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+
+			xor3@460000 {
+				compatible = "marvell,mv-xor-v2-z1";
+			};
+		};
+	};
 };
 
diff --git a/drivers/dma/mv_xor_v2.c b/drivers/dma/mv_xor_v2.c
index 7952c28..5f76e1d 100644
--- a/drivers/dma/mv_xor_v2.c
+++ b/drivers/dma/mv_xor_v2.c
@@ -63,8 +63,10 @@
 #define   GLOB_BW_CTRL_NUM_OSTD_WR_VAL		8
 #define   GLOB_BW_CTRL_RD_BURST_LEN_SHIFT	12
 #define   GLOB_BW_CTRL_RD_BURST_LEN_VAL		4
+#define   GLOB_BW_CTRL_RD_BURST_LEN_VAL_Z1	2
 #define   GLOB_BW_CTRL_WR_BURST_LEN_SHIFT	16
 #define   GLOB_BW_CTRL_WR_BURST_LEN_VAL      	4
+#define   GLOB_BW_CTRL_WR_BURST_LEN_VAL_Z1     	2
 #define GLOB_PAUSE		0x014
 #define   GLOB_PAUSE_AXI_TIME_DIS_VAL		0x8
 #define GLOB_SYS_INT_CAUSE	0x200
@@ -172,6 +174,17 @@ struct mv_xor_v2_sw_desc {
 };
 
 /*
+ * Hold XOR engine parameters depending on the matched
+ * compatible string.
+ */
+struct mv_xor_v2_compat_data {
+	u32 rd_burst_len;
+	u32 wr_burst_len;
+};
+
+static const struct of_device_id mv_xor_v2_dt_ids[];
+
+/*
  * Fill the data buffers to a HW descriptor
  */
 static void mv_xor_v2_set_data_buffers(struct mv_xor_v2_device *xor_dev,
@@ -654,6 +667,8 @@ static void mv_xor_v2_set_msi_msg(struct msi_desc *desc, struct msi_msg *msg)
 static int mv_xor_v2_descq_init(struct mv_xor_v2_device *xor_dev)
 {
 	u32 reg;
+	const struct of_device_id *match;
+	struct mv_xor_v2_compat_data *data;
 
 	/* write the DESQ size to the DMA engine */
 	writel(MV_XOR_V2_MAX_DESC_NUM, xor_dev->dma_base + DMA_DESQ_SIZE_OFF);
@@ -693,10 +708,15 @@ static int mv_xor_v2_descq_init(struct mv_xor_v2_device *xor_dev)
 	 * -  Limit the number of outstanding write & read data
 	 *    (OBB/IBB) requests to the maximal value.
 	*/
+	match = of_match_node(mv_xor_v2_dt_ids, xor_dev->dmadev.dev->of_node);
+	if (WARN_ON(!match))
+		return -1;
+	data = (struct mv_xor_v2_compat_data *)match->data;
+
 	reg = (GLOB_BW_CTRL_NUM_OSTD_RD_VAL << GLOB_BW_CTRL_NUM_OSTD_RD_SHIFT) |
 		(GLOB_BW_CTRL_NUM_OSTD_WR_VAL << GLOB_BW_CTRL_NUM_OSTD_WR_SHIFT) |
-		(GLOB_BW_CTRL_RD_BURST_LEN_VAL << GLOB_BW_CTRL_RD_BURST_LEN_SHIFT) |
-		(GLOB_BW_CTRL_WR_BURST_LEN_VAL << GLOB_BW_CTRL_WR_BURST_LEN_SHIFT);
+		(data->rd_burst_len << GLOB_BW_CTRL_RD_BURST_LEN_SHIFT) |
+		(data->wr_burst_len << GLOB_BW_CTRL_WR_BURST_LEN_SHIFT);
 	writel(reg, xor_dev->glob_base + GLOB_BW_CTRL);
 
 	/* Disable the AXI timer feature */
@@ -856,10 +876,25 @@ static int mv_xor_v2_remove(struct platform_device *pdev)
 }
 
 #ifdef CONFIG_OF
-static struct of_device_id mv_xor_v2_dt_ids[] = {
-	{ .compatible = "marvell,mv-xor-v2", },
+
+struct mv_xor_v2_compat_data xor_compat_data = {
+	.rd_burst_len = GLOB_BW_CTRL_RD_BURST_LEN_VAL,
+	.wr_burst_len = GLOB_BW_CTRL_WR_BURST_LEN_VAL
+};
+
+struct mv_xor_v2_compat_data xor_compat_data_z1 = {
+	.rd_burst_len = GLOB_BW_CTRL_RD_BURST_LEN_VAL_Z1,
+	.wr_burst_len = GLOB_BW_CTRL_WR_BURST_LEN_VAL_Z1
+};
+
+static const struct of_device_id mv_xor_v2_dt_ids[] = {
+	{ .compatible = "marvell,mv-xor-v2",
+	  .data = &xor_compat_data},
+	{ .compatible = "marvell,mv-xor-v2-z1",
+	  .data = &xor_compat_data_z1 },
 	{},
 };
+
 MODULE_DEVICE_TABLE(of, mv_xor_v2_dt_ids);
 #endif
 
-- 
2.7.4

